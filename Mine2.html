<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, orientation=landscape">
    <title>Steve Parkour - Music Sync</title>
    <style>
        body { margin: 0; overflow: hidden; background: #9db9eb; font-family: 'Arial', sans-serif; touch-action: none; }
        canvas { display: block; }
        #menu {
            position: absolute; width: 100%; height: 100%;
            background: linear-gradient(rgba(135, 206, 235, 0.7), rgba(157, 185, 235, 0.9));
            display: flex; flex-direction: column; align-items: center; justify-content: space-between;
            z-index: 200; padding: 40px 0; box-sizing: border-box;
        }
        .menu-btn {
            width: 280px; padding: 18px; background: #4caf50; border: none; border-bottom: 6px solid #2e7d32;
            border-radius: 8px; font-size: 22px; font-weight: bold; color: white; cursor: pointer; text-shadow: 2px 2px 0px rgba(0,0,0,0.3);
        }
        #ui { position: absolute; top: 10px; left: 10px; background: rgba(255,255,255,0.9); padding: 12px; border-radius: 5px; border: 2px solid #333; z-index: 10; display: none; }
        .controls { position: absolute; bottom: 20px; width: 100%; display: none; justify-content: center; gap: 40px; z-index: 10; }
        .btn { width: 80px; height: 80px; background: rgba(255,255,255,0.8); border: 3px solid #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; }
    </style>
</head>
<body>

    <div id="menu">
        <h1>STEVE PARKOUR</h1>
        <div id="status">CHECKPOINT MUDA A MÚSICA!</div>
        <div class="menu-btn" onclick="startGame()">JOGAR COM MÚSICA DINÂMICA</div>
    </div>

    <div id="ui"><b>DISTÂNCIA: <span id="dist">0</span>m</b></div>
    <div class="controls" id="gameControls">
        <div class="btn" id="left">←</div><div class="btn" id="right">→</div><div class="btn" id="jump" style="width:120px; border-radius:40px;">PULO</div>
    </div>

    <canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
let cameraX = 0, world = {}, lastGeneratedX = 0, gameActive = false;
let audioCtx, melodyInterval, currentNoteIndex = 0;
let currentScale = [261.63, 293.66, 329.63, 349.23, 392.00, 440.00]; // Escala Inicial

const scales = [
    [261.63, 293.66, 329.63, 392.00, 440.00], // Pentatônica Maior
    [233.08, 261.63, 277.18, 311.13, 349.23], // Misteriosa
    [196.00, 220.00, 246.94, 293.66, 329.63], // Alegre
    [130.81, 146.83, 164.81, 174.61, 196.00]  // Baixo Grave
];

function playMelody() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    clearInterval(melodyInterval);
    melodyInterval = setInterval(() => {
        if (!gameActive) return;
        let osc = audioCtx.createOscillator();
        let gain = audioCtx.createGain();
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(currentScale[currentNoteIndex % currentScale.length], audioCtx.currentTime);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.3);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.3);
        currentNoteIndex++;
    }, 250);
}

function changeMusic() {
    // Muda para uma escala aleatória a cada checkpoint
    currentScale = scales[Math.floor(Math.random() * scales.length)];
    console.log("Música mudou!");
}

const player = { x: 80, y: 350, w: 32, h: 56, vx: 0, vy: 0, speed: 4.4, jump: -14, onGround: false, animStep: 0 };

function startGame() {
    document.getElementById("menu").style.display = "none";
    document.getElementById("ui").style.display = "block";
    document.getElementById("gameControls").style.display = "flex";
    world = {}; lastGeneratedX = 0; player.x = 80; player.y = 350; cameraX = 0;
    for(let i=0; i<6; i++) world[`${i*50},450`] = "grass";
    expandWorld(300);
    gameActive = true;
    playMelody();
}

function expandWorld(startX) {
    let x = startX;
    let y = 450;
    for(let i = 0; i < 12; i++) {
        x += 145 + Math.random() * 55;
        y += (Math.random() - 0.5) * 160;
        y = Math.max(250, Math.min(canvas.height - 150, y));
        let gx = Math.floor(x/50)*50;
        let gy = Math.floor(y/50)*50;
        world[`${gx},${gy}`] = (i === 11) ? "gold" : "stone";
    }
    lastGeneratedX = x;
}

function update() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    if (!gameActive) { drawSteve(0, 0, 3.5, true); requestAnimationFrame(update); return; }

    player.x += player.vx; player.vy += 0.7; player.y += player.vy;
    let gx = Math.floor((player.x+16)/50)*50, gy = Math.floor((player.y+player.h)/50)*50;
    
    if(world[`${gx},${gy}`]) {
        if(world[`${gx},${gy}`] === "gold") {
            world[`${gx},${gy}`] = "stone"; // Consome o checkpoint
            changeMusic(); // TROCA A MÚSICA
        }
        player.y = gy - player.h; player.vy = 0; player.onGround = true;
    } else player.onGround = false;

    if (player.x + 1000 > lastGeneratedX) expandWorld(lastGeneratedX);
    cameraX += (player.x - canvas.width/3 - cameraX) * 0.1;
    
    for (let pos in world) {
        let [bx, by] = pos.split(",").map(Number);
        if (bx > cameraX - 50 && bx < cameraX + canvas.width) {
            ctx.fillStyle = world[pos] === "gold" ? "#ffd700" : "#757575";
            ctx.fillRect(bx - cameraX, by, 50, 50);
        }
    }
    drawSteve(player.x, player.y, 1, false);
    requestAnimationFrame(update);
}

// Funções de desenho do Steve (Mantendo sua textura 3x visível no menu)
function drawSteve(x, y, scale, isMenu) {
    let sx = isMenu ? canvas.width/2 - (16*scale) : x - cameraX;
    let sy = isMenu ? canvas.height/2 - (40*scale) : y;
    ctx.save();
    ctx.lineWidth = isMenu ? 6 : 2; ctx.strokeStyle = "black";
    ctx.fillStyle = "#3c44aa"; ctx.fillRect(sx+4*scale, sy+34*scale, 12*scale, 20*scale); // Pernas
    ctx.fillStyle = "#3aa0a2"; ctx.fillRect(sx+4*scale, sy+10*scale, 24*scale, 24*scale); // Tronco
    ctx.fillStyle = "#d3a395"; ctx.fillRect(sx+4*scale, sy-14*scale, 24*scale, 24*scale); // Cabeça
    ctx.restore();
}

// Controles
const input = { left: false, right: false };
document.getElementById("left").ontouchstart = () => player.vx = -4.4;
document.getElementById("right").ontouchstart = () => player.vx = 4.4;
document.getElementById("jump").ontouchstart = () => { if(player.onGround) player.vy = -14; };
document.body.ontouchend = () => player.vx = 0;

update();
</script>
</body>
</html>
