<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, orientation=landscape">
    <title>Steve Parkour Deluxe</title>
    <style>
        body { margin: 0; overflow: hidden; background: #9db9eb; font-family: 'Arial', sans-serif; touch-action: none; }
        canvas { display: block; }
        #ui { position: absolute; top: 15px; left: 20px; color: #333; background: rgba(255,255,255,0.85); padding: 10px 20px; border-radius: 8px; border-bottom: 4px solid #aaa; pointer-events: none; z-index: 100; }
        #fs-btn { position: absolute; top: 15px; right: 20px; padding: 12px; background: #fff; border: 2px solid #333; border-radius: 8px; font-weight: bold; cursor: pointer; z-index: 100; }
        .controls { position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: space-between; padding: 0 50px; box-sizing: border-box; z-index: 100; }
        .btn-circle { width: 75px; height: 75px; background: rgba(255,255,255,0.7); border-radius: 50%; border: 3px solid #fff; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; color: #555; user-select: none; }
        .btn-circle:active { background: #fff; transform: scale(0.9); }
        #jump-btn { width: 110px; border-radius: 35px; }
    </style>
</head>
<body>
    <div id="ui">
        <b>Nível: <span id="lvlNum">1</span></b> | <b>Mortes: <span id="deathNum">0</span></b>
    </div>
    <button id="fs-btn">TELA CHEIA</button>
    <div class="controls">
        <div style="display: flex; gap: 15px;">
            <div class="btn-circle" id="btnLeft">←</div>
            <div class="btn-circle" id="btnRight">→</div>
        </div>
        <div class="btn-circle" id="jump-btn">PULO</div>
    </div>
<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
let currentLevel = 1, deaths = 0, world = {}, particles = [], cameraX = 0, isChangingLevel = false;
const gridSize = 48;

const player = { 
    x: 100, y: 300, w: 28, h: 52, 
    vx: 0, vy: 0, speed: 4.3, jump: -13.5, 
    onGround: false, animStep: 0, state: 'idle'
};

function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.onresize = resize; resize();

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playSound(freq, type, dur) {
    if(audioCtx.state === 'suspended') return;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    if(type === 'sawtooth') osc.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + dur);
    gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
    gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + dur);
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start(); osc.stop(audioCtx.currentTime + dur);
}

function spawnParticles(x, y, color) {
    for(let i=0; i<20; i++) {
        particles.push({
            x: x, y: y, 
            vx: (Math.random()-0.5)*12, vy: (Math.random()-0.5)*12, 
            life: 1, color: color
        });
    }
}

function generateLevel(lvl) {
    world = {}; player.x = 80; player.y = 300; player.vx = 0; player.vy = 0;
    cameraX = 0; isChangingLevel = false;
    for(let i=0; i<5; i++) world[`${i*gridSize},${480}`] = "grass";
    let lastX = 250, lastY = 480;
    for(let i = 0; i < 8 + lvl; i++) {
        lastX += 135 + Math.random() * 60;
        lastY += (Math.random() - 0.5) * 160;
        lastY = Math.max(250, Math.min(canvas.height - 120, lastY));
        world[`${Math.floor(lastX/gridSize)*gridSize},${Math.floor(lastY/gridSize)*gridSize}`] = (i === 7 + lvl) ? "gold" : "stone";
    }
}

const input = { left: false, right: false, jump: false };
const setup = (id, k) => {
    const el = document.getElementById(id);
    el.addEventListener('touchstart', (e) => { e.preventDefault(); input[k] = true; audioCtx.resume(); });
    el.addEventListener('touchend', (e) => { e.preventDefault(); input[k] = false; });
};
setup("btnLeft", "left"); setup("btnRight", "right"); setup("jump-btn", "jump");

function drawSteve(x, y) {
    let sx = x - cameraX;
    let armSwing = Math.sin(player.animStep) * 15;
    let legSwing = Math.sin(player.animStep) * 15;

    if(!player.onGround) { armSwing = -20; legSwing = 15; } // Pose de Pulo
    if(Math.abs(player.vx) < 0.1 && player.onGround) { armSwing = 0; legSwing = 0; } // Idle

    ctx.save();
    ctx.lineWidth = 2; ctx.strokeStyle = "black";

    // Braço Longe
    ctx.fillStyle = "#d3a395";
    ctx.fillRect(sx + 10 - armSwing/2, y + 15, 8, 18);

    // Pernas (com animação de tesoura)
    ctx.fillStyle = "#4a4db4";
    ctx.fillRect(sx + 4, y + 35 + (legSwing > 0 ? 0 : -2), 10, 18);
    ctx.fillRect(sx + 14, y + 35 + (legSwing > 0 ? -2 : 0), 10, 18);

    // Tronco
    ctx.fillStyle = "#3ab0a2";
    ctx.fillRect(sx + 4, y + 10, 20, 25);

    // Cabeça
    ctx.fillStyle = "#d3a395";
    ctx.fillRect(sx + 2, y - 14, 24, 24);
    ctx.fillStyle = "#5d3a1a"; ctx.fillRect(sx+2, y-14, 24, 6); // Cabelo
    
    // Olhos
    ctx.fillStyle = "white"; ctx.fillRect(sx+5, y-2, 6, 4); ctx.fillRect(sx+15, y-2, 6, 4);
    ctx.fillStyle = "#4c4cae"; ctx.fillRect(sx+7, y-2, 2, 4); ctx.fillRect(sx+17, y-2, 2, 4);

    // Braço Perto
    ctx.fillStyle = "#d3a395";
    ctx.fillRect(sx + 10 + armSwing/2, y + 15, 8, 18);

    ctx.restore();
}

function update() {
    if(isChangingLevel) { draw(); requestAnimationFrame(update); return; }

    if (input.left) { player.vx = -player.speed; player.animStep += 0.25; }
    else if (input.right) { player.vx = player.speed; player.animStep += 0.25; }
    else { player.vx *= 0.8; player.animStep = 0; }

    player.x += player.vx;
    if(check(player.x+2, player.y+5) || check(player.x+player.w-2, player.y+5)) player.x -= player.vx;

    player.vy += 0.65; player.y += player.vy;
    let feet = check(player.x+5, player.y+player.h) || check(player.x+player.w-5, player.y+player.h);
    
    if(feet) {
        if(feet === "gold") {
            isChangingLevel = true;
            spawnParticles(player.x - cameraX, player.y, "#ffd700");
            playSound(600, 'sine', 0.3); // Som de vitória
            currentLevel++; 
            document.getElementById("lvlNum").innerText = currentLevel;
            setTimeout(() => generateLevel(currentLevel), 500);
            return;
        }
        player.y = Math.floor((player.y+player.h)/gridSize)*gridSize - player.h;
        player.vy = 0; player.onGround = true;
    } else player.onGround = false;

    if(input.jump && player.onGround) { 
        player.vy = player.jump; 
        player.onGround = false; 
        playSound(200, 'square', 0.1); // Som de pulo
    }
    
    if(player.y > canvas.height + 100) { 
        deaths++; 
        document.getElementById("deathNum").innerText = deaths;
        playSound(120, 'sawtooth', 0.2); // Som de OOF
        generateLevel(currentLevel); 
    }

    cameraX += (player.x - canvas.width/3 - cameraX) * 0.1;
    draw();
    requestAnimationFrame(update);
}

function check(px, py) {
    return world[`${Math.floor(px/gridSize)*gridSize},${Math.floor(py/gridSize)*gridSize}`];
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    for (let pos in world) {
        const [x, y] = pos.split(",").map(Number);
        let sx = x - cameraX;
        if(world[pos] === "grass") {
            ctx.fillStyle = "#795548"; ctx.fillRect(sx, y, gridSize, gridSize);
            ctx.fillStyle = "#4caf50"; ctx.fillRect(sx, y, gridSize, 12);
        } else if(world[pos] === "stone") {
            ctx.fillStyle = "#888"; ctx.fillRect(sx, y, gridSize, gridSize);
        } else if(world[pos] === "gold") {
            ctx.fillStyle = "#ffd700"; ctx.fillRect(sx, y, gridSize, gridSize);
            ctx.strokeRect(sx+4, y+4, gridSize-8, gridSize-8);
        }
    }
    drawSteve(player.x, player.y);

    // Desenhar Partículas
    particles.forEach((p, i) => {
        p.x += p.vx; p.y += p.vy; p.life -= 0.02;
        ctx.fillStyle = p.color;
        ctx.globalAlpha = p.life;
        ctx.fillRect(p.x, p.y, 8, 8);
        if(p.life <= 0) particles.splice(i, 1);
    });
    ctx.globalAlpha = 1;
}

document.getElementById("fs-btn").onclick = () => document.documentElement.requestFullscreen();
generateLevel(1); update();
</script>
</body>
</html>
