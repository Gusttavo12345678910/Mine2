<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, orientation=landscape">
    <title>Steve Parkour - Particle Edition</title>
    <style>
        body { margin: 0; overflow: hidden; background: #9db9eb; font-family: 'Arial', sans-serif; touch-action: none; }
        canvas { display: block; }
        
        #menu {
            position: absolute; width: 100%; height: 100%;
            background: rgba(157, 185, 235, 0.95);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 200; gap: 15px;
        }
        
        .menu-btn {
            width: 280px; padding: 18px; background: #4caf50; border: none; border-bottom: 6px solid #2e7d32;
            border-radius: 8px; font-size: 22px; font-weight: bold; color: white; cursor: pointer; text-align: center;
        }

        #nameInput {
            width: 260px; padding: 12px; font-size: 18px; border: 3px solid #333;
            border-radius: 5px; text-align: center;
        }

        #highScoreText {
            color: #fff; font-size: 16px; background: rgba(0,0,0,0.6); 
            padding: 8px 20px; border-radius: 30px; border: 2px solid #ffd700;
        }

        #ui { position: absolute; top: 10px; left: 10px; background: rgba(255,255,255,0.9); padding: 12px; border-radius: 5px; border: 2px solid #333; z-index: 10; display: none; }
        
        .controls { position: absolute; bottom: 20px; width: 100%; display: none; justify-content: center; gap: 40px; z-index: 10; }
        
        .btn { 
            width: 80px; height: 80px; background: rgba(255,255,255,0.8); 
            border: 3px solid #333; border-radius: 50%; display: flex; 
            align-items: center; justify-content: center; font-size: 28px; font-weight: bold; 
        }
    </style>
</head>
<body>

    <div id="menu">
        <h1 style="color:white; text-shadow: 4px 4px #000; margin: 0;">STEVE PARKOUR</h1>
        <div id="highScoreText">A carregar recorde...</div>
        <input type="text" id="nameInput" placeholder="Teu apelido..." maxlength="12">
        <div class="menu-btn" onclick="startGame()">INICIAR SPEEDRUN</div>
        <div style="color:#555; font-size:12px; cursor:pointer;" onclick="localStorage.clear(); location.reload();">Resetar Dados</div>
    </div>

    <div id="ui">
        <b>JOGADOR: <span id="displayName">Steve</span></b><br>
        <b style="color:#2e7d32;">METROS: <span id="dist">0</span>/1000m</b><br>
        <b>TEMPO: <span id="timer">0.0</span>s</b>
    </div>

    <div class="controls" id="gameControls">
        <div id="left" class="btn">←</div>
        <div id="right" class="btn">→</div>
        <div id="jump" class="btn" style="width:120px; border-radius:40px;">PULO</div>
    </div>

    <canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
let cameraX = 0, world = {}, lastGeneratedX = 0, gameActive = false, startTime = 0;
let playerName = "Steve", stepTimer = 0;
let particles = []; // Array para guardar as partículas

// SISTEMA DE RECORDE
function updateMenuRecord() {
    let score = localStorage.getItem("highScore") || 0;
    let holder = localStorage.getItem("scoreHolder") || "Ninguém";
    document.getElementById("highScoreText").innerText = `MELHOR: ${score}m por ${holder}`;
}
updateMenuRecord();

if(localStorage.getItem("playerName")) {
    document.getElementById("nameInput").value = localStorage.getItem("playerName");
}

// SONS
let audioCtx;
function playSound(f, t, d, v) {
    if(!audioCtx) return;
    let o = audioCtx.createOscillator();
    let g = audioCtx.createGain();
    o.type = t; o.frequency.setValueAtTime(f, audioCtx.currentTime);
    g.gain.setValueAtTime(v, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + d);
    o.connect(g); g.connect(audioCtx.destination);
    o.start(); o.stop(audioCtx.currentTime + d);
}

const player = { x: 80, y: 350, w: 32, h: 56, vx: 0, vy: 0, speed: 5, jump: -16, onGround: false, animStep: 0 };

function startGame() {
    playerName = document.getElementById("nameInput").value.trim() || "Steve";
    localStorage.setItem("playerName", playerName);
    document.getElementById("displayName").innerText = playerName;
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    document.getElementById("menu").style.display = "none";
    document.getElementById("ui").style.display = "block";
    document.getElementById("gameControls").style.display = "flex";
    world = {}; lastGeneratedX = 0; player.x = 80; player.y = 350; cameraX = 0; particles = [];
    for(let i=0; i<8; i++) world[`${i*50},450`] = "grass";
    expandWorld(400);
    gameActive = true; startTime = Date.now();
}

function expandWorld(startX) {
    let x = startX;
    for(let i = 0; i < 20; i++) {
        x += 160 + Math.random() * 50;
        let gy = 300 + (Math.random()*180);
        let pos = `${Math.floor(x/50)*50},${Math.floor(gy/50)*50}`;
        world[pos] = (i === 19) ? "save" : "grass";
    }
    lastGeneratedX = x;
}

// FUNÇÃO PARA CRIAR EXPLOSÃO DE PARTÍCULAS
function createBurst(x, y) {
    for(let i=0; i<20; i++) {
        particles.push({
            x: x, y: y,
            vx: (Math.random() - 0.5) * 10, // Espalha para os lados
            vy: (Math.random() - 1) * 15,   // Joga para cima
            life: 1.0,
            color: Math.random() > 0.5 ? "#ffd700" : "#ffffff" // Dourado ou Branco
        });
    }
}

// DESENHO DO STEVE (HEROBRINE)
function drawSteve(x, y, scale, isMenu) {
    let sx = isMenu ? canvas.width/2 - (16*scale) : x - cameraX;
    let sy = isMenu ? canvas.height/2 - (30*scale) : y;
    let swing = isMenu ? 0 : Math.sin(player.animStep) * 1.2;

    ctx.save();
    if(!isMenu) {
        ctx.fillStyle = "rgba(0,0,0,0.5)"; ctx.font = "bold 14px Arial";
        let tw = ctx.measureText(playerName).width;
        ctx.fillRect(sx + (16*scale) - (tw/2) - 4, sy - 35, tw + 8, 20);
        ctx.fillStyle = "white"; ctx.fillText(playerName, sx + (16*scale) - (tw/2), sy - 20);
    }
    ctx.lineWidth = isMenu ? 4 : 2; ctx.strokeStyle = "black";
    // Membros Longe
    ctx.fillStyle = "#303a9e"; ctx.fillRect(sx + 4*scale, sy + 34*scale + (swing*5), 10*scale, 20*scale);
    ctx.fillStyle = "#d3a395"; ctx.fillRect(sx - 2*scale, sy + 10*scale - (swing*8), 7*scale, 22*scale);
    // Corpo/Cabeça
    ctx.fillStyle = "#3aa0a2"; ctx.fillRect(sx + 4*scale, sy + 10*scale, 22*scale, 24*scale);
    ctx.fillStyle = "#d3a395"; ctx.fillRect(sx + 3*scale, sy - 14*scale, 24*scale, 24*scale);
    ctx.strokeRect(sx + 3*scale, sy - 14*scale, 24*scale, 24*scale);
    // Cabelo/Olhos Brancos
    ctx.fillStyle = "#5d3a1a"; ctx.fillRect(sx + 3*scale, sy - 14*scale, 24*scale, 6*scale);
    ctx.fillStyle = "white"; 
    ctx.fillRect(sx + 6*scale, sy - 2*scale, 5*scale, 4*scale); 
    ctx.fillRect(sx + 18*scale, sy - 2*scale, 5*scale, 4*scale); 
    // Membros Perto
    ctx.fillStyle = "#3c44aa"; ctx.fillRect(sx + 15*scale, sy + 34*scale - (swing*5), 10*scale, 20*scale);
    ctx.fillStyle = "#e5b6ab"; ctx.fillRect(sx + 25*scale, sy + 10*scale + (swing*8), 7*scale, 22*scale);
    ctx.restore();
}

const input = { left: false, right: false };
document.getElementById("left").ontouchstart = (e) => { e.preventDefault(); input.left = true; };
document.getElementById("right").ontouchstart = (e) => { e.preventDefault(); input.right = true; };
document.body.ontouchend = () => { input.left = false; input.right = false; };
document.getElementById("jump").ontouchstart = (e) => {
    if(player.onGround) { player.vy = player.jump; playSound(200, 'triangle', 0.2, 0.1); }
};

function update() {
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    if (!gameActive) { drawSteve(0, 0, 4, true); requestAnimationFrame(update); return; }

    let distMetros = Math.floor(player.x/50);
    document.getElementById("dist").innerText = distMetros;
    document.getElementById("timer").innerText = ((Date.now() - startTime) / 1000).toFixed(1);

    if(distMetros >= 1000) { alert("META ATINGIDA: 1000 METROS!"); location.reload(); }

    if (input.left) { player.vx = -player.speed; player.animStep += 0.2; }
    else if (input.right) { player.vx = player.speed; player.animStep += 0.2; }
    else { player.vx *= 0.8; player.animStep = 0; }

    player.x += player.vx; player.vy += 0.8; player.y += player.vy;

    if(player.onGround && Math.abs(player.vx) > 1 && Date.now() > stepTimer) {
        playSound(100, 'sine', 0.05, 0.02); stepTimer = Date.now() + 250;
    }

    let gx = Math.floor((player.x+16)/50)*50, gy = Math.floor((player.y+player.h)/50)*50;
    if(world[`${gx},${gy}`]) {
        if(world[`${gx},${gy}`] === "save") {
            playSound(600, 'sine', 0.4, 0.1); 
            createBurst(gx + 25, gy + 25); // CRIA PARTÍCULAS NO CENTRO DO BLOCO
            world[`${gx},${gy}`] = "grass"; 
        }
        player.y = gy - player.h; player.vy = 0; player.onGround = true;
    } else player.onGround = false;

    if (player.y > canvas.height + 100) {
        let best = parseInt(localStorage.getItem("highScore") || 0);
        if(distMetros > best) { localStorage.setItem("highScore", distMetros); localStorage.setItem("scoreHolder", playerName); }
        gameActive = false; updateMenuRecord(); document.getElementById("menu").style.display = "flex";
    }

    if (player.x + 800 > lastGeneratedX) expandWorld(lastGeneratedX);
    cameraX += (player.x - canvas.width/3 - cameraX) * 0.1;

    for (let pos in world) {
        let [bx, by] = pos.split(",").map(Number);
        if(bx > cameraX - 100 && bx < cameraX + canvas.width + 100) {
            ctx.fillStyle = world[pos] === "save" ? "#ffd700" : "#795548";
            ctx.fillRect(bx - cameraX, by, 50, 50);
            if(world[pos] === "save") {
                ctx.fillStyle = "black"; ctx.font = "bold 12px Arial"; ctx.fillText("SAVE", bx - cameraX + 8, by + 30);
            } else {
                ctx.fillStyle = "#4caf50"; ctx.fillRect(bx - cameraX, by, 50, 15);
            }
        }
    }

    // ATUALIZAR E DESENHAR PARTÍCULAS
    particles.forEach(p => {
        p.x += p.vx; p.y += p.vy; p.vy += 0.5; // Gravidade nas partículas
        p.life -= 0.03;
        ctx.fillStyle = `rgba(255, 215, 0, ${p.life})`; // Cor dourada que desaparece
        ctx.fillRect(p.x - cameraX, p.y, 8, 8);
    });
    particles = particles.filter(p => p.life > 0); // Remove partículas mortas

    drawSteve(player.x, player.y, 1, false);
    requestAnimationFrame(update);
}
update();
</script>
</body>
</html>
